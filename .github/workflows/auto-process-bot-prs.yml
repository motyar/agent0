name: Auto-Process Bot Tasks

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  process-task:
    if: |
      github.actor == 'github-actions[bot]' && 
      contains(github.event.pull_request.labels.*.name, 'bot-task')
    
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: npm install
      
      - name: Extract task from PR
        id: task
        run: |
          # Get PR details and extract task description
          TASK=$(gh pr view ${{ github.event.pull_request.number }} --json body -q '.body' | grep "**Task:**" | sed 's/.*\*\*Task:\*\* *//' | head -n 1 | xargs)
          if [ -z "$TASK" ]; then
            echo "Warning: Could not extract task from PR body"
            TASK="${{ github.event.pull_request.title }}"
          fi
          echo "task=$TASK" >> $GITHUB_OUTPUT
          echo "Processing task: $TASK"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Process task with agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TASK_DESCRIPTION: ${{ steps.task.outputs.task }}
        run: |
          echo "ğŸ¤– Agent processing task..."
          node src/agent.js process-pr $PR_NUMBER
      
      - name: Commit changes
        run: |
          git config user.name "Agent0 Bot"
          git config user.email "agent0@github.com"
          
          git add -A
          
          if ! git diff --staged --quiet; then
            git commit -m "âœ¨ Implemented: ${{ steps.task.outputs.task }}" -m "[automated-commit]"
            git push
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes needed"
          fi
        id: commit
      
      - name: Update PR with status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "âœ… Task processed by Agent0
            
            **Status:** Implementation complete
            **Changes:** ${{ steps.commit.outputs.changes_made }}
            
            Ready for review and merge! ğŸš€"
      
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto --squash \
            --body "ğŸ¤– Auto-merging task completion"
