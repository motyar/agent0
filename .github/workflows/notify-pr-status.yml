name: Notify on PR Status

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read

jobs:
  notify-user:
    if: contains(github.event.pull_request.labels.*.name, 'agent-code-change')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: npm install
      
      - name: Extract user info from PR
        id: extract_user
        run: |
          # Extract user ID from PR body (format: "User ID: 123456")
          USER_ID=$(echo "${{ github.event.pull_request.body }}" | grep "User ID:" | sed 's/.*User ID: \([0-9]*\).*/\1/')
          echo "user_id=$USER_ID" >> $GITHUB_OUTPUT
          echo "Extracted user ID: $USER_ID"
      
      - name: Send notification on approval
        if: github.event.review.state == 'approved'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          USER_ID: ${{ steps.extract_user.outputs.user_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          node -e "
          const fetch = require('node-fetch');
          const token = process.env.TELEGRAM_BOT_TOKEN;
          const userId = process.env.USER_ID;
          const prNumber = process.env.PR_NUMBER;
          const prUrl = process.env.PR_URL;
          const prTitle = process.env.PR_TITLE;
          
          if (!userId) {
            console.log('No user ID found, skipping notification');
            process.exit(0);
          }
          
          const message = \`âœ… **PR Approved!**\n\nYour code change PR #\${prNumber} has been approved!\n\nðŸ“ **Title:** \${prTitle}\n\nðŸ”— **Link:** \${prUrl}\n\nðŸŽ‰ The changes are ready to be merged. You can merge it now or wait for auto-merge.\`;
          
          fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: userId,
              text: message,
              parse_mode: 'Markdown'
            })
          }).then(r => r.json()).then(console.log).catch(console.error);
          "
      
      - name: Send notification on merge
        if: github.event.pull_request.merged == true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          USER_ID: ${{ steps.extract_user.outputs.user_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          node -e "
          const fetch = require('node-fetch');
          const token = process.env.TELEGRAM_BOT_TOKEN;
          const userId = process.env.USER_ID;
          const prNumber = process.env.PR_NUMBER;
          const prUrl = process.env.PR_URL;
          const prTitle = process.env.PR_TITLE;
          
          if (!userId) {
            console.log('No user ID found, skipping notification');
            process.exit(0);
          }
          
          const message = \`ðŸŽ‰ **PR Merged!**\n\nYour code change PR #\${prNumber} has been successfully merged!\n\nðŸ“ **Title:** \${prTitle}\n\nðŸ”— **Link:** \${prUrl}\n\nâœ¨ The changes are now live in the main branch!\`;
          
          fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: userId,
              text: message,
              parse_mode: 'Markdown'
            })
          }).then(r => r.json()).then(console.log).catch(console.error);
          "
      
      - name: Send notification on close without merge
        if: github.event.pull_request.merged == false && github.event.action == 'closed'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          USER_ID: ${{ steps.extract_user.outputs.user_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          node -e "
          const fetch = require('node-fetch');
          const token = process.env.TELEGRAM_BOT_TOKEN;
          const userId = process.env.USER_ID;
          const prNumber = process.env.PR_NUMBER;
          const prUrl = process.env.PR_URL;
          const prTitle = process.env.PR_TITLE;
          
          if (!userId) {
            console.log('No user ID found, skipping notification');
            process.exit(0);
          }
          
          const message = \`âŒ **PR Closed**\n\nYour code change PR #\${prNumber} was closed without merging.\n\nðŸ“ **Title:** \${prTitle}\n\nðŸ”— **Link:** \${prUrl}\n\nIf you need to make changes, feel free to ask me to create a new PR!\`;
          
          fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: userId,
              text: message,
              parse_mode: 'Markdown'
            })
          }).then(r => r.json()).then(console.log).catch(console.error);
          "
