name: Webhook Handler

on:
  repository_dispatch:
    types: [telegram-message, external-event]
  workflow_dispatch:
    inputs:
      event_type:
        description: 'Event type to process'
        required: true
        type: choice
        options:
          - telegram-message
          - health-check
          - custom
      payload:
        description: 'Event payload (JSON)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  handle-webhook:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Process telegram message
        if: github.event.action == 'telegram-message' || github.event.inputs.event_type == 'telegram-message'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "üì® Processing Telegram message via webhook..."
          
          # Poll for messages
          node src/telegram.js poll
          
          # Process any pending messages
          node src/agent.js process
      
      - name: Run health check
        if: github.event.inputs.event_type == 'health-check'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üè• Running health check..."
          npm run doctor
      
      - name: Handle custom event
        if: github.event.inputs.event_type == 'custom'
        env:
          EVENT_PAYLOAD: ${{ github.event.inputs.payload }}
        run: |
          echo "üîß Processing custom event..."
          echo "Payload: $EVENT_PAYLOAD"
          # Add custom event handling logic here
      
      - name: Commit changes
        run: |
          git config user.name "Agent0"
          git config user.email "agent0@github.com"
          
          # Add any modified files (queue, memory, etc.)
          git add -A
          
          # Commit if there are changes
          git diff --staged --quiet || git commit -m "üìù Webhook event processed: $(date --iso-8601=seconds)"
          
          # Push changes
          git push || echo "Nothing to push"
      
      - name: Report status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Webhook processed successfully"
          else
            echo "‚ùå Webhook processing failed"
          fi

  # Optional: Send response back (if webhook source supports it)
  send-response:
    needs: handle-webhook
    runs-on: ubuntu-latest
    if: github.event.client_payload.response_url
    
    steps:
      - name: Send webhook response
        env:
          RESPONSE_URL: ${{ github.event.client_payload.response_url }}
        run: |
          curl -X POST "$RESPONSE_URL" \
            -H "Content-Type: application/json" \
            -d '{"status": "completed", "timestamp": "'$(date --iso-8601=seconds)'"}'
